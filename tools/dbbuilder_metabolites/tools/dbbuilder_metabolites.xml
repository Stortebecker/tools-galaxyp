<tool id="dbbuilder_metabolites" name="Metabolite Database Downloader" version="0.0.1">

<description>
  A tool to download free metabolite spectral databases (e.g. Golm DB, HMDB). 
</description>

<requirements>
  <requirement type="binary">wget</requirement>
</requirements>

<stdio>
  <exit_code range="1:"  level="fatal" description="Error downloading database." />
  <regex match="ERROR" level="fatal" source="stderr" description="Error downloading database." />
  <!-- TODO: escape quotes. -->
</stdio>

<command>
  <!-- Beispiel aus Original dbbuilder: -->
  <!--   <![CDATA[
    #if $source.from == "uniprot"
      #set $url = "http://www.uniprot.org/uniprot/?query=taxonomy%3a%22" + str($source.taxon) + "%22" + str($source.set) + str($source.reviewed) + "&amp;force=yes&amp;format=fasta" + str($source.include_isoform)
      #set $type = "direct"
    #elif $source.from == "cRAP"
      #set $url = "ftp://ftp.thegpm.org/fasta/cRAP/crap.fasta"
      #set $type = "direct"
    #elif $source.from == "url"
      #set $url = $source.url
      #set $type = "direct"
    #end if
    
    #if $type =="direct"
      wget -nv '$url' -O '${output_database}'
    #end if
  ]]> -->
  
  <!-- TODO1: Rausfinden, wie sich die download-urls zusammensetzen! -->  
  <!-- TODO2: Brauche ich hier den $type ? -->  
  <!-- TODO3: Eventuell wird noch ein Parameter $measurement_type (GC-MS, NMR, LC-MS) benÃ¶tigt -->  
  
  
  <![CDATA[
    #if $source.from == "mona"
      #set $url = 
    #elif $source.from == "golm"
      #set $url = 
    #elif $source.from == "url"
      #set $url = $source.url    
    #end if
    
    wget -nv '$url' -O '${output_database}'
    ]]>
    
</command>

<inputs>
  <conditional name="source">  
    <param name="from" type="select" label="Download from" help="Select database source.">
      <option value="mona">MoNA DB</option>
      <option value="mona">HMDB DB</option>   
      <option value="golm">Golm DB</option>
      <option value="url">Custom URL</option>
    </param>
    
    <when value="mona">
    <!-- TODO: Rausfinden, welche Params ich brauche -->
      <param name="taxon" type="select" format="text" help="Select type of database">
        <label>Taxonomy</label>
        <options from_file="uniprot_taxons.loc">
          <column name="name" index="0" />
          <column name="value" index="1" />
        </options>
      </param>
      
      <param name="reviewed" type="select" help="UniProtKB/TrEMBL (unreviewed)is a large, automatically annotated database- may contain redundant sequences, but there is a higher chance peptides will be identified. UniProtKB/Swiss-Prot (reviewed) is a smaller, manually annotated database- less of a chance peptides will be identified but less sequence redundancy">
        <option value="+">UniProtKB</option>
        <option value="+reviewed%3Ayes">UniProtKB/Swiss-Prot (reviewed only)</option>
        <option value="+reviewed%3Ano">UniProtKB/TrEMBL (unreviewed only)</option>
        <sanitizer>
          <valid>
            <add value="%"/>
          </valid>
        </sanitizer>
      </param>
      
      <param name="set" type="select" label="Proteome Set">
        <option value="+">Any</option>
        <option value="+keyword%3a1185" selected="true">Reference Proteome Set</option>
        <option value="+keyword%3a181">Complete Proteome Set</option>
        <sanitizer>
          <valid>
            <add value="%"/>
          </valid>
        </sanitizer>
      </param>
      
      <param name="include_isoform" type="boolean" truevalue="&amp;include=yes" falsevalue="" label="Include isoform data" help="several different forms of a given protein are incorporated into database" />
    </when>
    
    <when value="cRAP" />
    
    <when value="url">
      <param name="url" value="" type="text" label="URL (http, ftp)">
        <sanitizer>
          <valid>
            <add value="%"/>
          </valid>
        </sanitizer>
      </param>
    </when>
    
  </conditional>
</inputs>

<outputs>
  <data format="fasta" name="output_database" label="Protein Database" />
</outputs>

<help>
<![CDATA[
**Comments**

The tool currently covers GC-MS databases only. No common file format has been established for metabolomics databases so far, therefore you have to consider:
  
- **Caution 1:** Databases are sometimes provided by different online sources in different formats. The databases might not contain the same data, if downloaded in another format. An example would be the Human Metabolome Database (HMDB), which natively uses XML format. It can also be accessed online using the MassBank of Northern America (MoNA), which uses MSP or JSON format. 
- **Caution 2:**  "MSP" or "MSL" format is not always the same. Many databases use a slightly different way to write "MSP" format. The different formats usually contain the same type of information, but use a unique file structure. Thus, not all "MSP" formats are directly compatible.

**Output**

Creates a database file of the requested database in the requested format.

**External links**

The Metabolomics Society provides an overview on different free databases: http://metabolomicssociety.org/resources/metabolomics-databases
]]>
</help>

</tool>

